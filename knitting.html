<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stitchle - Elegant Knitting Wordle</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Source+Sans+Pro:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Source Sans Pro", sans-serif;
        background: linear-gradient(135deg, #f8f6f4 0%, #f2f0ed 100%);
        color: #2c2c2c;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
      }

      /* Subtle textured background */
      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: linear-gradient(
            45deg,
            transparent 49%,
            rgba(180, 160, 140, 0.02) 50%,
            transparent 51%
          ),
          linear-gradient(
            -45deg,
            transparent 49%,
            rgba(160, 140, 120, 0.02) 50%,
            transparent 51%
          );
        background-size: 20px 20px;
        z-index: -3;
      }

      /* Refined typography */
      h1 {
        font-family: "Playfair Display", serif;
        color: #4a4a4a;
        margin-bottom: 8px;
        font-size: 2.8rem;
        font-weight: 600;
        position: relative;
        z-index: 1;
        background: rgba(248, 246, 244, 0.9);
        padding: 15px 30px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.2);
        letter-spacing: -0.5px;
      }

      p {
        margin-top: 0;
        font-size: 1rem;
        color: #6b5b4d;
        background: rgba(248, 246, 244, 0.8);
        padding: 8px 20px;
        border-radius: 8px;
        backdrop-filter: blur(5px);
        font-weight: 400;
      }

      /* Sophisticated panel design */
      .reddit-panel {
        width: 100%;
        max-width: 900px;
        background: rgba(252, 250, 248, 0.95);
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1),
          0 8px 20px rgba(0, 0, 0, 0.05);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        position: relative;
        z-index: 1;
      }

      .reddit-title {
        font-family: "Playfair Display", serif;
        font-size: 1.8rem;
        color: #4a4a4a;
        text-align: center;
        margin-bottom: 30px;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      .subreddit-tabs {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 25px;
        border-bottom: 2px solid #e8e4e0;
        padding-bottom: 20px;
      }

      .tab-btn {
        padding: 10px 18px;
        background: linear-gradient(135deg, #f8f6f4 0%, #f0ede9 100%);
        border: 1px solid #d8d4d0;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        color: #5a5a5a;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-family: "Source Sans Pro", sans-serif;
      }

      .tab-btn:hover {
        background: linear-gradient(135deg, #6b5b4d 0%, #5a4d41 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(107, 91, 77, 0.2);
        border-color: #6b5b4d;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
        color: white;
        border-color: #4a4a4a;
        box-shadow: 0 2px 8px rgba(74, 74, 74, 0.3);
      }

      .sort-controls {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 25px;
      }

      .sort-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #f5f3f1 0%, #ebe8e4 100%);
        border: 1px solid #d0ccc8;
        border-radius: 6px;
        cursor: pointer;
        color: #5a5a5a;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .sort-btn:hover {
        background: linear-gradient(135deg, #8b7355 0%, #6d5a47 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(139, 115, 85, 0.2);
        border-color: #8b7355;
      }

      .sort-btn.active {
        background: linear-gradient(135deg, #6b5b4d 0%, #5a4d41 100%);
        color: white;
        border-color: #6b5b4d;
      }

      .posts-container {
        max-height: 450px;
        overflow-y: auto;
        padding-right: 10px;
      }

      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin: 20px 0 10px 0;
        padding: 15px;
        background: rgba(248, 246, 244, 0.4);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .page-btn {
        padding: 10px 18px;
        background: linear-gradient(135deg, #6b5b4d 0%, #5a4d41 100%);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
        min-width: 90px;
        box-shadow: 0 3px 10px rgba(107, 91, 77, 0.2);
      }

      .page-btn:hover:not(:disabled) {
        background: linear-gradient(135deg, #5a4d41 0%, #4a3f35 100%);
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(107, 91, 77, 0.3);
      }

      .page-btn:disabled {
        background: linear-gradient(135deg, #c8c4c0 0%, #b8b4b0 100%);
        cursor: not-allowed;
        opacity: 0.6;
      }

      .page-info {
        font-size: 0.9rem;
        color: #6b5b4d;
        font-weight: 500;
        margin: 0 10px;
      }

      .posts-container::-webkit-scrollbar {
        width: 6px;
      }

      .posts-container::-webkit-scrollbar-track {
        background: rgba(240, 237, 233, 0.5);
        border-radius: 3px;
      }

      .posts-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #c8beb4 0%, #a8998f 100%);
        border-radius: 3px;
      }

      .posts-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #a8998f 0%, #88796f 100%);
      }

      .post-item {
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(252, 250, 248, 0.8) 100%
        );
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .post-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: rgba(107, 91, 77, 0.2);
      }

      .post-title {
        font-weight: 600;
        color: #2c2c2c;
        margin-bottom: 10px;
        font-size: 1rem;
        line-height: 1.4;
      }

      .post-title a {
        color: inherit;
        text-decoration: none;
        transition: color 0.3s ease;
      }

      .post-title a:hover {
        color: #6b5b4d;
      }

      .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #8a7a6a;
        margin-bottom: 12px;
        font-weight: 400;
      }

      .post-score {
        background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
        color: white;
        padding: 4px 10px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.8rem;
      }

      .post-image {
        width: 100%;
        max-height: 220px;
        object-fit: cover;
        border-radius: 8px;
        margin-top: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .post-actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
      }

      .favorite-btn {
        padding: 8px 16px;
        border: 1px solid #d0ccc8;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #f8f6f4 0%, #f0ede9 100%);
        color: #6b5b4d;
      }

      .favorite-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        background: linear-gradient(135deg, #8b7355 0%, #6d5a47 100%);
        color: white;
        border-color: #8b7355;
      }

      .favorite-btn.favorited {
        background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
        color: white;
        border-color: #d4af37;
      }

      .favorite-btn.favorited:hover {
        background: linear-gradient(135deg, #b8941f 0%, #9e7a1a 100%);
      }

      .loading {
        text-align: center;
        color: #8a7a6a;
        font-style: italic;
        padding: 25px;
        font-size: 1rem;
      }

      .error {
        text-align: center;
        color: #a66;
        padding: 25px;
        background: rgba(240, 235, 235, 0.8);
        border-radius: 8px;
        margin: 15px 0;
        border: 1px solid rgba(170, 102, 102, 0.2);
      }

      /* Elegant game styling */
      #grid {
        display: grid;
        grid-template-rows: repeat(6, 60px);
        gap: 8px;
        margin: 25px 0;
        padding: 25px;
        background: rgba(252, 250, 248, 0.9);
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08),
          0 4px 10px rgba(0, 0, 0, 0.04);
        backdrop-filter: blur(15px);
        position: relative;
        z-index: 1;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .row {
        display: grid;
        grid-template-columns: repeat(5, 60px);
        gap: 8px;
      }

      .cell {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        font-weight: 600;
        border-radius: 8px;
        text-transform: uppercase;
        background: linear-gradient(135deg, #f8f6f4 0%, #f0ede9 100%);
        color: #2c2c2c;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5),
          0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: 1px solid rgba(208, 204, 200, 0.3);
        font-family: "Source Sans Pro", sans-serif;
      }

      .green {
        background: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
        color: white;
        border-color: #4a4a4a;
        box-shadow: 0 2px 8px rgba(74, 74, 74, 0.3);
      }
      .yellow {
        background: linear-gradient(135deg, #8b7355 0%, #6d5a47 100%);
        color: white;
        border-color: #8b7355;
        box-shadow: 0 2px 8px rgba(139, 115, 85, 0.3);
      }
      .red {
        background: linear-gradient(135deg, #a66 0%, #944 100%);
        color: white;
        border-color: #a66;
        box-shadow: 0 2px 8px rgba(170, 102, 102, 0.3);
      }

      #guess-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        width: 100%;
        max-width: 320px;
        position: relative;
        z-index: 1;
      }

      input {
        padding: 15px 20px;
        font-size: 1.2rem;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #d0ccc8;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.9) 0%,
          rgba(252, 250, 248, 0.9) 100%
        );
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05),
          0 1px 0 rgba(255, 255, 255, 0.5);
        text-transform: uppercase;
        outline: none;
        color: #2c2c2c;
        font-weight: 500;
        transition: all 0.3s ease;
        font-family: "Source Sans Pro", sans-serif;
      }

      input:focus {
        border-color: #6b5b4d;
        box-shadow: 0 0 0 3px rgba(107, 91, 77, 0.1),
          inset 0 1px 3px rgba(0, 0, 0, 0.05);
      }

      button {
        padding: 15px 25px;
        font-size: 1rem;
        cursor: pointer;
        background: linear-gradient(135deg, #6b5b4d 0%, #5a4d41 100%);
        border: none;
        border-radius: 8px;
        color: white;
        box-shadow: 0 4px 12px rgba(107, 91, 77, 0.3);
        transition: all 0.3s ease;
        font-weight: 600;
        font-family: "Source Sans Pro", sans-serif;
      }

      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(107, 91, 77, 0.4);
        background: linear-gradient(135deg, #5a4d41 0%, #4a3f35 100%);
      }

      #reset-btn {
        margin-top: 15px;
        background: linear-gradient(135deg, #8b7355 0%, #6d5a47 100%);
        box-shadow: 0 4px 12px rgba(139, 115, 85, 0.3);
      }

      #reset-btn:hover {
        background: linear-gradient(135deg, #6d5a47 0%, #5a4838 100%);
        box-shadow: 0 6px 20px rgba(139, 115, 85, 0.4);
      }

      #message {
        margin-top: 15px;
        font-weight: 500;
        min-height: 28px;
        color: #4a4a4a;
        text-align: center;
        font-size: 1rem;
        background: rgba(252, 250, 248, 0.8);
        padding: 10px 20px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Refined back button */
      #back-btn {
        position: fixed;
        top: 25px;
        left: 25px;
        z-index: 10;
        padding: 10px 16px;
        border-radius: 8px;
        border: none;
        background: linear-gradient(135deg, #6b5b4d 0%, #5a4d41 100%);
        color: white;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(107, 91, 77, 0.3);
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-family: "Source Sans Pro", sans-serif;
      }

      #back-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(107, 91, 77, 0.4);
      }

      /* Elegant gallery styling */
      .pattern-gallery {
        margin: 4rem auto;
        padding: 2rem;
        text-align: center;
        max-width: 950px;
        background: rgba(252, 250, 248, 0.8);
        border-radius: 16px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .gallery-title {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        margin-bottom: 2rem;
        color: #4a4a4a;
        font-weight: 600;
        letter-spacing: -0.3px;
      }

      .gallery-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
        gap: 1.5rem;
      }

      .gallery-grid a {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.8) 0%,
          rgba(252, 250, 248, 0.8) 100%
        );
        border-radius: 12px;
        padding: 1.2rem;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
        text-decoration: none;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      .gallery-grid a:hover {
        transform: translateY(-3px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
        border-color: rgba(107, 91, 77, 0.2);
      }

      .gallery-grid img {
        border-radius: 8px;
        max-width: 100%;
        height: auto;
        margin-bottom: 0.8rem;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1);
      }

      .gallery-grid p {
        font-family: "Source Sans Pro", sans-serif;
        font-size: 0.9rem;
        color: #5a5a5a;
        font-weight: 500;
      }

      /* Mobile responsiveness */
      @media (max-width: 768px) {
        .window {
          width: 200px;
          height: 130px;
          right: 20px;
          top: 30px;
        }

        .reading-chair {
          width: 70px;
          height: 65px;
          left: 40px;
          bottom: 60px;
        }

        .yarn-display {
          right: 80px;
          bottom: 80px;
          transform: scale(0.8);
        }

        .knitting-needles {
          left: 60px;
          top: 150px;
        }

        .subreddit-tabs {
          justify-content: flex-start;
          overflow-x: auto;
          padding-bottom: 15px;
        }

        .tab-btn {
          flex-shrink: 0;
          font-size: 0.8rem;
          padding: 8px 14px;
        }

        .reddit-panel {
          margin: 15px 10px;
          padding: 20px;
        }

        h1 {
          font-size: 2.2rem;
          padding: 12px 24px;
        }

        #grid {
          grid-template-rows: repeat(6, 55px);
          gap: 6px;
          padding: 20px;
        }

        .row {
          grid-template-columns: repeat(5, 55px);
          gap: 6px;
        }

        .cell {
          font-size: 1.3rem;
        }
      }

      @media (max-width: 480px) {
        .window {
          width: 150px;
          height: 100px;
          right: 10px;
          top: 20px;
        }

        .scissors,
        .knitting-needles {
          display: none;
        }

        .reading-chair {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Elegant room elements -->
    <div class="window">
      <div class="window-content">
        <div class="tree tree1"></div>
        <div class="tree tree2"></div>
        <div class="tree tree3"></div>
      </div>
    </div>

    <div class="reading-chair">
      <div class="chair-arm-right"></div>
    </div>

    <div class="yarn-display">
      <div class="yarn-shelf"></div>
      <div class="yarn-skein skein1"></div>
      <div class="yarn-skein skein2"></div>
      <div class="yarn-skein skein3"></div>
    </div>

    <div class="knitting-needles"></div>
    <div class="scissors">‚úÇ</div>

    <!-- Back button -->
    <button id="back-btn" onclick="goBack()">‚Üê Back</button>

    <!-- Reddit Panel -->
    <div class="reddit-panel">
      <h2 class="reddit-title">Community Craft</h2>

      <div class="subreddit-tabs">
        <button class="tab-btn active" data-subreddit="knitting">
          r/knitting
        </button>
        <button class="tab-btn" data-subreddit="crochet">r/crochet</button>
        <button class="tab-btn" data-subreddit="sewing">r/sewing</button>
        <button class="tab-btn" data-subreddit="quilting">r/quilting</button>
        <button class="tab-btn" data-subreddit="embroidery">
          r/embroidery
        </button>
        <button class="tab-btn" data-subreddit="CrossStitch">
          r/CrossStitch
        </button>
        <button class="tab-btn" data-subreddit="weaving">r/weaving</button>
        <button class="tab-btn" data-tab="favorites">‚≠ê Favorites</button>
      </div>

      <div class="sort-controls">
        <button class="sort-btn active" data-sort="hot">Hot</button>
        <button class="sort-btn" data-sort="top">Top</button>
      </div>

      <div class="posts-container" id="posts-container">
        <div class="loading">Loading posts...</div>
      </div>

      <div class="pagination-controls">
        <button class="page-btn" id="prev-btn" onclick="previousPage()">
          ‚Üê Previous
        </button>
        <span class="page-info" id="page-info">Page 1</span>
        <button class="page-btn" id="next-btn" onclick="nextPage()">
          Next ‚Üí
        </button>
      </div>
    </div>

    <h1>Stitchle</h1>

    <div id="grid"></div>

    <form id="guess-form">
      <input
        id="guess-input"
        maxlength="5"
        placeholder="Type a 5-letter word"
        autofocus
      />
      <button type="submit">Guess</button>
    </form>

    <button id="reset-btn">Reset Guesses</button>
    <p id="message"></p>
    <script>
      // Back button function
      function goBack() {
        window.location.href = "https://gzsrsm.csb.app/";
      }

      // Reddit functionality
      let currentSubreddit = "knitting";
      let currentSort = "hot";
      let currentPage = 1;
      let allPosts = [];
      let postsPerPage = 5;
      let after = null; // Reddit's pagination token
      let currentTab = "subreddit"; // Track if we're viewing favorites or subreddit

      // IndexedDB setup for favorites
      let db;
      const dbName = "StitchleFavorites";
      const dbVersion = 1;

      // Initialize IndexedDB
      const initDB = () => {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            db = request.result;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains("favorites")) {
              const store = db.createObjectStore("favorites", {
                keyPath: "id",
              });
              store.createIndex("timestamp", "timestamp", { unique: false });
            }
          };
        });
      };

      // Save favorite post
      const saveFavorite = async (postData) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["favorites"], "readwrite");
          const store = transaction.objectStore("favorites");

          const favoritePost = {
            id: postData.id,
            title: postData.title,
            author: postData.author,
            score: postData.score,
            created_utc: postData.created_utc,
            permalink: postData.permalink,
            subreddit:
              postData.subreddit_name_prefixed || `r/${currentSubreddit}`,
            url: postData.url,
            preview: postData.preview,
            timestamp: Date.now(),
          };

          const request = store.add(favoritePost);
          request.onsuccess = () => resolve(favoritePost);
          request.onerror = () => reject(request.error);
        });
      };

      // Remove favorite post
      const removeFavorite = async (postId) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["favorites"], "readwrite");
          const store = transaction.objectStore("favorites");

          const request = store.delete(postId);
          request.onsuccess = () => resolve();
          request.onerror = () => reject(request.error);
        });
      };

      // Get all favorites
      const getFavorites = async () => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["favorites"], "readonly");
          const store = transaction.objectStore("favorites");
          const index = store.index("timestamp");

          const request = index.getAll();
          request.onsuccess = () => {
            // Sort by timestamp descending (newest first)
            const favorites = request.result.sort(
              (a, b) => b.timestamp - a.timestamp
            );
            resolve(favorites);
          };
          request.onerror = () => reject(request.error);
        });
      };

      // Check if post is favorited
      const isPostFavorited = async (postId) => {
        return new Promise((resolve, reject) => {
          const transaction = db.transaction(["favorites"], "readonly");
          const store = transaction.objectStore("favorites");

          const request = store.get(postId);
          request.onsuccess = () => resolve(!!request.result);
          request.onerror = () => reject(request.error);
        });
      };

      const subredditTabs = document.querySelectorAll(".tab-btn");
      const sortBtns = document.querySelectorAll(".sort-btn");
      const postsContainer = document.getElementById("posts-container");
      const pageInfo = document.getElementById("page-info");
      const prevBtn = document.getElementById("prev-btn");
      const nextBtn = document.getElementById("next-btn");

      // Tab switching
      subredditTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          subredditTabs.forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          if (tab.dataset.tab === "favorites") {
            currentTab = "favorites";
            loadFavorites();
          } else {
            currentTab = "subreddit";
            currentSubreddit = tab.dataset.subreddit;
            resetPagination();
            loadPosts();
          }

          // Scroll to top of Reddit panel when switching tabs
          document
            .querySelector(".reddit-panel")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });

      // Sort switching
      sortBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          // Only allow sorting for subreddit tabs, not favorites
          if (currentTab !== "subreddit") return;

          sortBtns.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentSort = btn.dataset.sort;
          resetPagination();
          loadPosts();
          // Scroll to top of Reddit panel when switching sort
          document
            .querySelector(".reddit-panel")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });

      function resetPagination() {
        currentPage = 1;
        allPosts = [];
        after = null;
        updatePaginationControls();
      }

      function updatePaginationControls() {
        if (currentTab === "favorites") {
          const totalPages = Math.ceil(allPosts.length / postsPerPage);
          pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
          prevBtn.disabled = currentPage <= 1;
          nextBtn.disabled = currentPage >= totalPages;
          return;
        }

        const totalPages = Math.ceil(allPosts.length / postsPerPage);
        const hasMorePages = after !== null; // Reddit has more pages

        pageInfo.textContent = `Page ${currentPage}`;
        prevBtn.disabled = currentPage <= 1;

        // Enable next if we have more posts in current batch OR if Reddit has more pages
        const currentPageEnd = currentPage * postsPerPage;
        nextBtn.disabled = !hasMorePages && currentPageEnd >= allPosts.length;
      }

      function previousPage() {
        if (currentPage > 1) {
          currentPage--;
          displayCurrentPage();
          updatePaginationControls();
          // Scroll Reddit panel to top
          document
            .querySelector(".reddit-panel")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      async function nextPage() {
        if (currentTab === "favorites") {
          // For favorites, just check if we have more posts to show
          const currentPageEnd = currentPage * postsPerPage;
          if (currentPageEnd < allPosts.length) {
            currentPage++;
            displayCurrentPage();
            updatePaginationControls();
            document
              .querySelector(".reddit-panel")
              .scrollIntoView({ behavior: "smooth", block: "start" });
          }
          return;
        }

        const currentPageEnd = currentPage * postsPerPage;

        // If we need more posts and Reddit has more pages
        if (currentPageEnd >= allPosts.length && after !== null) {
          await loadMorePosts();
        }

        // Now check if we can go to next page
        if (currentPageEnd < allPosts.length) {
          currentPage++;
          displayCurrentPage();
          updatePaginationControls();
          // Scroll Reddit panel to top
          document
            .querySelector(".reddit-panel")
            .scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function displayCurrentPage() {
        const startIndex = (currentPage - 1) * postsPerPage;
        const endIndex = startIndex + postsPerPage;
        const postsToShow = allPosts.slice(startIndex, endIndex);

        displayPosts(postsToShow);
      }

      async function loadFavorites() {
        postsContainer.innerHTML =
          '<div class="loading">Loading favorites...</div>';

        try {
          const favorites = await getFavorites();

          if (favorites.length === 0) {
            postsContainer.innerHTML =
              '<div class="error">No favorites saved yet.<br>Click the ‚≠ê button on any post to save it!</div>';
            allPosts = [];
            currentPage = 1;
            updatePaginationControls();
            return;
          }

          // Convert favorites to post format
          allPosts = favorites.map((fav) => ({
            data: {
              id: fav.id,
              title: fav.title,
              author: fav.author,
              score: fav.score,
              created_utc: fav.created_utc,
              permalink: fav.permalink,
              subreddit_name_prefixed: fav.subreddit,
              url: fav.url,
              preview: fav.preview,
            },
          }));

          currentPage = 1;
          displayCurrentPage();
          updatePaginationControls();
        } catch (error) {
          console.error("Error loading favorites:", error);
          postsContainer.innerHTML =
            '<div class="error">Error loading favorites. Please try again.</div>';
        }
      }

      async function loadPosts() {
        postsContainer.innerHTML =
          '<div class="loading">Loading posts...</div>';

        try {
          // Using a CORS proxy to bypass Reddit's CORS restrictions
          const redditUrl = `https://www.reddit.com/r/${currentSubreddit}/${currentSort}.json?limit=25`;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(
            redditUrl
          )}`;

          const response = await fetch(proxyUrl);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          // Check if we got valid Reddit data
          if (!data || !data.data || !data.data.children) {
            throw new Error("Invalid response format from Reddit");
          }

          const posts = data.data.children;
          after = data.data.after; // Store pagination token

          if (posts.length === 0) {
            postsContainer.innerHTML =
              '<div class="error">No posts found.</div>';
            return;
          }

          allPosts = posts; // Store all posts
          currentPage = 1;
          displayCurrentPage();
          updatePaginationControls();
        } catch (error) {
          console.error("Error loading posts:", error);

          // Fallback: try alternative CORS proxy
          try {
            const redditUrl = `https://www.reddit.com/r/${currentSubreddit}/${currentSort}.json?limit=25`;
            const altProxyUrl = `https://corsproxy.io/?${encodeURIComponent(
              redditUrl
            )}`;

            const altResponse = await fetch(altProxyUrl);
            if (altResponse.ok) {
              const altData = await altResponse.json();
              if (altData && altData.data && altData.data.children) {
                allPosts = altData.data.children;
                after = altData.data.after;
                currentPage = 1;
                displayCurrentPage();
                updatePaginationControls();
                return;
              }
            }
          } catch (altError) {
            console.error("Alternative proxy also failed:", altError);
          }

          // Show user-friendly error message
          postsContainer.innerHTML = `
            <div class="error">
              <strong>Unable to load r/${currentSubreddit} posts</strong>
              <br>Trying to connect to Reddit...
              <br><button onclick="loadPosts()" style="margin-top: 10px; padding: 5px 10px; border: none; border-radius: 5px; background: #6b5b4d; color: white; cursor: pointer;">üîÑ Retry</button>
            </div>
          `;
        }
      }

      async function loadMorePosts() {
        if (!after) return; // No more pages

        try {
          const redditUrl = `https://www.reddit.com/r/${currentSubreddit}/${currentSort}.json?limit=25&after=${after}`;
          const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(
            redditUrl
          )}`;

          const response = await fetch(proxyUrl);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data && data.data && data.data.children) {
            const newPosts = data.data.children;
            allPosts = [...allPosts, ...newPosts]; // Append new posts
            after = data.data.after; // Update pagination token
          }
        } catch (error) {
          console.error("Error loading more posts:", error);
          // Try fallback proxy
          try {
            const redditUrl = `https://www.reddit.com/r/${currentSubreddit}/${currentSort}.json?limit=25&after=${after}`;
            const altProxyUrl = `https://corsproxy.io/?${encodeURIComponent(
              redditUrl
            )}`;

            const altResponse = await fetch(altProxyUrl);
            if (altResponse.ok) {
              const altData = await altResponse.json();
              if (altData && altData.data && altData.data.children) {
                const newPosts = altData.data.children;
                allPosts = [...allPosts, ...newPosts];
                after = altData.data.after;
              }
            }
          } catch (altError) {
            console.error("Alternative proxy failed for pagination:", altError);
          }
        }
      }

      async function displayPosts(posts) {
        postsContainer.innerHTML = "";

        for (const post of posts) {
          const data = post.data;
          const postElement = await createPostElement(data);
          postsContainer.appendChild(postElement);
        }
      }

      async function createPostElement(data) {
        const postDiv = document.createElement("div");
        postDiv.className = "post-item";

        const timeAgo = getTimeAgo(data.created_utc);
        const imageHtml = getImageHtml(data);
        const isFavorited = await isPostFavorited(data.id);

        const subredditDisplay =
          data.subreddit_name_prefixed || `r/${currentSubreddit}`;

        postDiv.innerHTML = `
          <div class="post-title">
            <a href="https://reddit.com${
              data.permalink
            }" target="_blank" rel="noopener">
              ${escapeHtml(data.title)}
            </a>
          </div>
          <div class="post-meta">
            <span>by u/${data.author} in ${subredditDisplay} ‚Ä¢ ${timeAgo}</span>
            <span class="post-score">‚Üë ${formatScore(data.score)}</span>
          </div>
          ${imageHtml}
          <div class="post-actions">
            <button class="favorite-btn ${isFavorited ? "favorited" : ""}" 
                    onclick="toggleFavorite('${data.id}', this)" 
                    data-post-id="${data.id}">
              ${isFavorited ? "‚≠ê Favorited" : "‚òÜ Save"}
            </button>
          </div>
        `;

        return postDiv;
      }

      function getImageHtml(data) {
        let imageUrl = null;

        // Check for preview images - always use the first image if multiple exist
        if (
          data.preview &&
          data.preview.images &&
          data.preview.images.length > 0
        ) {
          // Get the first image from the preview
          const firstImage = data.preview.images[0];
          if (firstImage && firstImage.source && firstImage.source.url) {
            imageUrl = firstImage.source.url.replace(/&amp;/g, "&");
          }
        }
        // Check for Reddit gallery posts
        else if (data.is_gallery && data.media_metadata) {
          // Get the first image from the gallery
          const mediaIds = Object.keys(data.media_metadata);
          if (mediaIds.length > 0) {
            const firstMediaId = mediaIds[0];
            const firstMedia = data.media_metadata[firstMediaId];
            if (firstMedia && firstMedia.s && firstMedia.s.u) {
              imageUrl = firstMedia.s.u.replace(/&amp;/g, "&");
            }
          }
        }
        // Check for direct image links
        else if (data.url && data.url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
          imageUrl = data.url;
        }
        // Check for imgur links
        else if (
          data.url &&
          data.url.includes("imgur.com") &&
          !data.url.includes("/a/") &&
          !data.url.includes("/gallery/")
        ) {
          imageUrl = data.url.replace("imgur.com", "i.imgur.com");
          if (!imageUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
            imageUrl += ".jpg";
          }
        }

        if (imageUrl) {
          return `<img src="${imageUrl}" alt="Post image" class="post-image" onerror="this.style.display='none'" loading="lazy">`;
        }

        return "";
      }

      function getTimeAgo(timestamp) {
        const now = Date.now() / 1000;
        const diff = now - timestamp;

        if (diff < 60) return "just now";
        if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
        if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
        return `${Math.floor(diff / 86400)}d ago`;
      }

      function formatScore(score) {
        if (score >= 1000) {
          return (score / 1000).toFixed(1) + "k";
        }
        return score.toString();
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Toggle favorite function
      window.toggleFavorite = async function (postId, buttonElement) {
        try {
          const isFavorited = await isPostFavorited(postId);

          if (isFavorited) {
            await removeFavorite(postId);
            buttonElement.classList.remove("favorited");
            buttonElement.textContent = "‚òÜ Save";

            // If we're in favorites view, refresh the list
            if (currentTab === "favorites") {
              setTimeout(() => loadFavorites(), 100);
            }
          } else {
            // Find the post data to save
            const postData = allPosts.find((p) => p.data.id === postId)?.data;
            if (postData) {
              await saveFavorite(postData);
              buttonElement.classList.add("favorited");
              buttonElement.textContent = "‚≠ê Favorited";
            }
          }
        } catch (error) {
          console.error("Error toggling favorite:", error);
        }
      };

      // Initialize database and load initial posts
      initDB()
        .then(() => {
          loadPosts();
        })
        .catch((error) => {
          console.error("Failed to initialize database:", error);
          loadPosts(); // Still load posts even if DB fails
        });

      // Ensure page starts at the very top
      window.scrollTo(0, 0);

      // Also scroll to top after a brief delay to handle any loading delays
      setTimeout(() => {
        window.scrollTo(0, 0);
      }, 100);

      // Game code (unchanged from original)
      const words = [
        "CABLE",
        "LACEY",
        "MOSSY",
        "RIBBY",
        "SEEDY",
        "LOOPS",
        "SPOOL",
        "FIBER",
        "WOOLY",
        "PURLS",
        "STITCH",
        "BOBBY",
        "BALLS",
        "YARNS",
        "HOOKS",
        "TASSE",
        "LOOMY",
        "SHEAR",
        "TWIST",
        "FELTS",
        "PLAIT",
        "KNOBS",
        "WEAVE",
        "CLOTH",
        "THREAD",
        "FABRI",
        "SPINS",
        "KNITS",
        "CROCH",
        "ROVIN",
        "FELTE",
        "POMPO",
        "BUNNY",
        "BRUSH",
        "CRAFT",
        "QUILT",
        "SEAMS",
        "SHAPE",
        "STONE",
        "WOOLS",
        "TWINE",
        "ROLLS",
        "PASTE",
        "GAUGE",
        "LOOPY",
        "BANDS",
        "PINCH",
        "LATCH",
        "WEFTS",
        "TWILL",
        "TAPES",
        "SKILL",
        "EMBRO",
        "BOBIN",
        "HANKS",
        "SEWED",
        "STASH",
        "NEEDL",
        "THRED",
        "PLUSH",
        "PATCH",
        "BINDI",
        "PINNY",
        "LOOMI",
        "FLOCK",
        "LOOPI",
        "TASSE",
        "TWEED",
        "LOOMS",
        "NEEDS",
        "SHELF",
        "CLIPS",
        "THREAD",
        "BALLS",
        "FABRI",
        "PLAIT",
        "YARNS",
        "LOOPS",
        "KNITS",
        "FELTS",
        "SPINS",
        "POMPO",
        "QUILT",
        "WOOLS",
        "WEAVE",
        "BINDI",
        "SEWED",
        "TWINE",
        "PINNY",
        "GAUGE",
        "TASSE",
        "PLUSH",
        "PATCH",
        "LATCH",
        "TWILL",
        "TAPES",
        "SKILL",
        "EMBRO",
        "BOBIN",
        "HANKS",
        "SEWED",
        "STASH",
        "FIBER",
        "LOOMS",
        "POMPO",
        "QUILT",
        "CROCH",
        "KNITS",
        "PLAIT",
        "LOOPI",
        "NEEDL",
        "HOOKS",
        "SPINS",
        "THREAD",
        "BALLS",
        "FELTS",
        "TWINE",
        "SPOOL",
        "CRAFT",
        "LOOPS",
        "KNOBS",
        "TASSE",
        "LOOMY",
        "SHEAR",
        "ROVIN",
        "PINNY",
        "SEAMS",
        "STONE",
        "WEAVE",
        "WOOLS",
        "BUNNY",
        "BRUSH",
        "PLUSH",
        "PATCH",
        "TWEED",
      ];

      const grid = document.getElementById("grid");
      const input = document.getElementById("guess-input");
      const form = document.getElementById("guess-form");
      const message = document.getElementById("message");
      const resetBtn = document.getElementById("reset-btn");
      const maxGuesses = 6;

      function getESTDateString() {
        const now = new Date();
        const estOffset = -5 * 60;
        const utc = now.getTime() + now.getTimezoneOffset() * 60000;
        const est = new Date(utc + estOffset * 60000);
        return est.toISOString().split("T")[0];
      }

      function getDailyWord() {
        const dateStr = getESTDateString();
        const savedWord = localStorage.getItem("stitchle_word_" + dateStr);
        if (savedWord) return savedWord;
        const index =
          dateStr.split("").reduce((acc, c) => acc + c.charCodeAt(0), 0) %
          words.length;
        const word = words[index];
        localStorage.setItem("stitchle_word_" + dateStr, word);
        return word;
      }

      let answer = getDailyWord();
      let guesses = JSON.parse(
        localStorage.getItem("stitchle_guesses_" + getESTDateString()) || "[]"
      );

      function renderGrid() {
        grid.innerHTML = "";
        for (let i = 0; i < maxGuesses; i++) {
          const rowDiv = document.createElement("div");
          rowDiv.classList.add("row");
          const guess = guesses[i] || "";
          for (let j = 0; j < 5; j++) {
            const cell = document.createElement("div");
            cell.classList.add("cell");
            const letter = guess[j] || "";
            cell.textContent = letter.toUpperCase();
            if (letter) {
              if (letter === answer[j]) cell.classList.add("green");
              else if (answer.includes(letter)) cell.classList.add("yellow");
              else cell.classList.add("red");
            }
            rowDiv.appendChild(cell);
          }
          grid.appendChild(rowDiv);
        }
      }

      function submitGuess() {
        const guess = input.value.toUpperCase();
        if (guess.length !== 5) {
          message.textContent = "Please enter a 5-letter word.";
          return;
        }
        guesses.push(guess);
        localStorage.setItem(
          "stitchle_guesses_" + getESTDateString(),
          JSON.stringify(guesses)
        );
        renderGrid();
        input.value = "";

        if (guess === answer) {
          message.textContent = `üéâ You guessed it! The word was "${answer}".`;
          input.disabled = true;
          form.querySelector("button").disabled = true;
        } else if (guesses.length >= maxGuesses) {
          message.textContent = `‚ùå Out of guesses! The word was "${answer}".`;
          input.disabled = true;
          form.querySelector("button").disabled = true;
        } else {
          message.textContent = `Guesses left: ${maxGuesses - guesses.length}`;
        }
      }

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        submitGuess();
      });

      resetBtn.addEventListener("click", () => {
        guesses = [];
        localStorage.removeItem("stitchle_guesses_" + getESTDateString());
        message.textContent = "";
        input.disabled = false;
        form.querySelector("button").disabled = false;
        input.focus();
        renderGrid();
      });

      renderGrid();
    </script>
  </body>
</html>
